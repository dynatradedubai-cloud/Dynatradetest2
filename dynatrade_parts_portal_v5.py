<FULL FINAL CODE FROM PREVIOUS MESSAGE>